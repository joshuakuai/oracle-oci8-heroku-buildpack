#!/usr/bin/env ruby

require 'tempfile'
require 'fileutils'
require 'open-uri'

$stdout.sync = true

def indent msg
  puts "       #{msg}"
end

def failDownload
  indent "Failure while downloading Oracle instant client: #{$?}"
end

puts "-----> Found a .oracle.ini"

DROPBOX_LINK="https://dl.dropboxusercontent.com/u/213980957/"
ORACLE_INSTANT_BASIC_ZIP="#{DROPBOX_LINK}/instantclient-basic-linux-12.1.0.2.0.zip"
ORACLE_INSTANT_SDK_ZIP="#{DROPBOX_LINK}/instantclient-sdk-linux-12.1.0.2.0.zip"
ORACLE_INSTANT_SQLPLUS_ZIP="#{DROPBOX_LINK}/instantclient-sqlplus-linux-12.1.0.2.0.zip"

ORACLE_INSTANT_CLIENT_DIR="#{ARGV[0]}/oracle"
ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR="#{ARGV[0]}/downloads"

FileUtils::mkdir_p ORACLE_INSTANT_CLIENT_DIR
FileUtils::mkdir_p ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR

if (File.exists?(ORACLE_INSTANT_CLIENT_DIR) && File.exists?(ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR))
  indent "Oracle instant folder created."
else
  indent "Failed to create the Oracle instant folder."
end

indent "Downloading and extracting archives from #{DROPBOX_LINK}..."

open("#{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/basic.zip", 'wb') do |file|
  file << open(ORACLE_INSTANT_BASIC_ZIP).read
end

`unzip #{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/basic.zip -d #{ORACLE_INSTANT_CLIENT_DIR}`
unless $?.success?
  failDownload
  exit 1
end

open("#{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/sdk.zip", 'wb') do |file|
  file << open(ORACLE_INSTANT_SDK_ZIP).read
end

`unzip #{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/sdk.zip -d #{ORACLE_INSTANT_CLIENT_DIR}`
unless $?.success?
  failDownload
  exit 1
end

open("#{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/sqlplus.zip", 'wb') do |file|
  file << open(ORACLE_INSTANT_SQLPLUS_ZIP).read
end

`unzip #{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/sqlplus.zip -d #{ORACLE_INSTANT_CLIENT_DIR}`
unless $?.success?
  failDownload
  exit 1
end

indent "All files have been downloaded."

indent "Setting environment varaible."

`cd #{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}`
`export LD_LIBRARY_PATH=#{ORACLE_INSTANT_CLIENT_DIR}/instantclient_12_1`

indent "Oracle instant client path set."
