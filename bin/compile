#!/usr/bin/env ruby

require 'tempfile'
require 'fileutils'

$stdout.sync = true

def indent msg
  puts "       #{msg}"
end

def failDownload
  indent "Failure while downloading Oracle instant client: #{$?}"
end

puts "-----> Found a .oracle.ini"

DROPBOX_LINK="https://dl.dropboxusercontent.com/u/213980957/"
ORACLE_INSTANT_BASIC_ZIP="#{DROPBOX_LINK}/instantclient-basic-linux-12.1.0.2.0.zip"
ORACLE_INSTANT_SDK_ZIP="#{DROPBOX_LINK}/instantclient-sdk-linux-12.1.0.2.0.zip"
ORACLE_INSTANT_SQLPLUS_ZIP="#{DROPBOX_LINK}/instantclient-sqlplus-linux-12.1.0.2.0.zip"

ORACLE_INSTANT_CLIENT_DIR="#{ARGV[0]}/oracle_instantclient"
ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR="#{ARGV[0]}/downloads"

indent "Making folders..."
`mkdir -p #{ORACLE_INSTANT_CLIENT_DIR}`
`mkdir -p #{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}`

indent "Downloading and extracting archives from #{DROPBOX_LINK}..."
result = `curl -o #{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/basic.zip #{ORACLE_INSTANT_BASIC_ZIP} && unzip #{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/basic.zip -d #{ORACLE_INSTANT_CLIENT_DIR}`

unless $?.success?
  failDownload
  exit 1
end

result = `curl -o #{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/sdk.zip #{ORACLE_INSTANT_SDK_ZIP} && unzip #{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/sdk.zip -d #{ORACLE_INSTANT_CLIENT_DIR}`

unless $?.success?
  failDownload
  exit 1
end

result = `curl -o #{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/sqlplus.zip #{ORACLE_INSTANT_SQLPLUS_ZIP} && unzip #{ORACLE_INSTANT_CLIENT_DOWNLOAD_DIR}/sqlplus.zip -d #{ORACLE_INSTANT_CLIENT_DIR}`

unless $?.success?
  failDownload
  exit 1
end

indent "All files have been downloaded."

`LD_LIBRARY_PATH=#{ORACLE_INSTANT_CLIENT_DIR}/instantclient_12_1`
`export LD_LIBRARY_PATH`

indent "Oracle instant client path set."
